<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapeo de Mensajes</title>
    <!-- Enlace a Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <!-- Enlace a CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <!-- Incluir el CSS de Shepherd.js para tour en la APP -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@13.0.0/dist/css/shepherd.css" />
    <!-- Enlace a la librería DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.css" />
    <!-- Enlace a la librería DataTables Buttons (para los botones de exportación) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.0/css/buttons.dataTables.min.css" />
    <!-- Enlaces a jQuery y Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

    <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>

    <script src="https://cdn.datatables.net/buttons/3.2.0/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.0/js/buttons.colVis.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.0/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.0/js/buttons.html5.min.js"></script>

    <!-- Incluir DataTables Column Reorder CSS y JS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/colreorder/2.0.4/css/colReorder.dataTables.css">
    <script type="text/javascript" charset="utf8"
        src="https://cdn.datatables.net/colreorder/2.0.4/js/dataTables.colReorder.js"></script>
    <script type="text/javascript" charset="utf8"
        src="https://cdn.datatables.net/colreorder/2.0.4/js/colReorder.dataTables.js"></script>

    <!-- Incluir la librería SheetJS para exportar a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/select/3.0.0/css/select.dataTables.css">
    <script type="text/javascript" charset="utf8"
        src="https://cdn.datatables.net/select/3.0.0/js/dataTables.select.js"></script>
    <script type="text/javascript" charset="utf8"
        src="https://cdn.datatables.net/select/3.0.0/js/select.dataTables.js"></script>
    <style>
        .accordion-button.bg-verde.collapsed {
            background-color: #d1e7dd !important;
        }

        .accordion-button.bg-celeste.collapsed {
            background-color: #cff4fc !important;
        }
    </style>
</head>

<body>
    <!-- Barra de navegación con fondo oscuro y texto en color blanco -->
    <nav class="navbar navbar-dark bg-dark">
        <!-- Contenedor fluido que asegura que el contenido ocupa todo el ancho disponible -->
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <!-- Logo a la izquierda -->
            <a class="navbar-brand" href="#">
                <img src="./assets/images/Bancolombiablanco.png" alt="Logo" class="d-inline-block align-top"
                    style="max-width: 100px; height: auto;">
            </a>
            <!-- Párrafo alineado a la derecha con el margen inferior eliminado -->
            <p class="mb-0">Versión: <span id="app-version"></span></p>
            <!-- El <span> con id="app-version" se usará para mostrar la versión de la aplicación -->
        </div>
    </nav>
    <div class="container my-5">
        <!-- Título de la página -->
        <h2 class="text-center mb-4">Mapeo de Mensajes</h2>
        <!-- Card para mostrar información del requerimiento -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="card-title">Requerimiento</h4>
                    <div class="d-flex align-items-center">
                        <button onclick="startTourComparerXML()" class="btn btn-primary btn-circle"
                            type="button" disabled>?</button>
                    </div>
                </div>

                <form id="formRequerimiento" class="needs-validation" novalidate>
                    <div class="accordion" id="accordionRequerimiento">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingRequerimiento">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseRequerimiento" aria-expanded="true"
                                    aria-controls="collapseRequerimiento">
                                    Descripción del Requerimiento
                                </button>
                            </h2>
                            <div id="collapseRequerimiento" class="accordion-collapse collapse show"
                                aria-labelledby="headingRequerimiento">
                                <div class="accordion-body">

                                    <!-- Contacto Técnico -->
                                    <div class="row mb-3">
                                        <label>Contacto Técnico:</label>
                                        <div class="col-md-6">
                                            <input type="text" class="form-control mb-2" id="nombreTecnico"
                                                placeholder="Nombres" required
                                                pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ]+(?:\s+[A-Za-zÁÉÍÓÚáéíóúÑñ]+)+$"
                                                title="Ingrese al menos nombre y apellido. Solo letras y espacios.">
                                        </div>
                                        <div class="col-md-6">
                                            <input type="email" class="form-control mb-2" id="correoTecnico"
                                                placeholder="Correo electrónico" required
                                                pattern="^[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}$"
                                                title="Ingrese un correo válido (ej. nombre@dominio.com)">
                                        </div>
                                        <div class="col-md-6">
                                            <input type="tel" class="form-control mb-2" id="telefonoUno"
                                                placeholder="Teléfono 1 fijo y/o celular" pattern="^\d{7,15}$"
                                                title="Ingresa un teléfono válido (solo números, entre 7 y 15 dígitos)"
                                                required>
                                        </div>
                                        <div class="col-md-6">
                                            <input type="tel" class="form-control mb-2" id="telefonoDos"
                                                placeholder="Teléfono 2 fijo y/o celular" pattern="^\d{7,15}$"
                                                title="Ingresa un teléfono válido (solo números, entre 7 y 15 dígitos)">
                                        </div>
                                    </div>

                                    <!-- Contacto Comercial Banco y Analista encargado -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label>Nombre Contacto Comercial Banco:</label>
                                            <input type="text" id="nombreComercial" class="form-control" required
                                                pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ]+(?:\s+[A-Za-zÁÉÍÓÚáéíóúÑñ]+)+$"
                                                title="Ingrese al menos nombre y apellido. Solo letras y espacios.">
                                        </div>
                                        <div class="col-md-6">
                                            <label>Nombre Analista Banco:</label>
                                            <input type="text" id="nombreAnalista" class="form-control" required
                                                pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ]+(?:\s+[A-Za-zÁÉÍÓÚáéíóúÑñ]+)+$"
                                                title="Ingrese al menos nombre y apellido. Solo letras y espacios.">
                                        </div>
                                    </div>

                                    <!-- Tipo de Web Service y Fecha vencimiento certificado -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="listaTipoWebService" class="form-label">Tipo de Web
                                                Service:</label>
                                            <select id="listaTipoWebService" class="form-select" required>
                                                <option value="" disabled selected>Selecciona una opción</option>
                                                <option value="una-via">RTR SOAP una vía</option>
                                                <option value="dos-vias">RIN SOAP dos vías</option>
                                                <option value="una-via-rest">RTR REST una vía</option>
                                                <option value="dos-vias-rest">RIN REST dos vías</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="fechaVencimientoCertificado">Certificado fecha
                                                vencimiento:</label>
                                            <input type="date" id="fechaVencimientoCertificado" class="form-control"
                                                required>
                                            <span id="fechaError" style="color: red; display: none;">El certificado debe
                                                tener mínimo un mes de vigencia.</span>
                                        </div>
                                    </div>

                                    <!-- Checks -->
                                    <div class="mb-3">
                                        <label>Características:</label><br>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" value="WSDL" id="wsdlCheck">
                                            <label class="form-check-label" for="wsdlCheck">WSDL</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" value="OAS" id="oasCheck">
                                            <label class="form-check-label" for="oasCheck">OpenAPI Specification</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" value="Firma"
                                                id="firmaCheck">
                                            <label class="form-check-label" for="firmaCheck">Firma</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" value="Cifrado"
                                                id="cifradoCheck">
                                            <label class="form-check-label" for="cifradoCheck">Cifrado</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="authBasicCheck"
                                                onchange="toggleAuthSelect()">
                                            <label class="form-check-label" for="authBasicCheck">Autenticación
                                                básica</label>
                                        </div>
                                    </div>

                                    <!-- Autenticación básica (condicional) -->
                                    <div class="mb-3" id="authBasic" style="display: none;">
                                        <label>Autenticación básica:</label>
                                        <select id="authBasicSelect" class="form-select">
                                            <option>Seleccione</option>
                                            <option>header soap</option>
                                            <option>http soap</option>
                                            <option>body</option>
                                            <option>N/A</option>
                                        </select>
                                    </div>

                                    <!-- Usuario y contraseña WS -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label>Usuario del WS cliente:</label>
                                            <input type="text" id="usuarioCiente" class="form-control" maxlength="20"
                                                required title="Ingrese el usuario (máx. 20 caracteres).">
                                        </div>
                                        <div class="col-md-6">
                                            <label>Contraseña del WS cliente:</label>
                                            <input type="text" id="passwordCiente" class="form-control" maxlength="20"
                                                required title="Ingrese la contraseña (máx. 20 caracteres).">
                                        </div>
                                    </div>

                                    <!-- URL y tipo de conectividad -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label>URL del servicio (endpoint):</label>
                                            <input type="url" class="form-control" id="urlServicio"
                                                placeholder="https://ejemplo.com/servicio" required
                                                pattern="^https?:\/\/[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}.*$"
                                                title="Ingrese una URL válida que comience con http:// o https:// (ej. https://ejemplo.com)">
                                        </div>
                                        <div class="col-md-6">
                                            <label>Tipo de conectividad:</label>
                                            <select class="form-select" id="tipoConectividad"
                                                onchange="toggleVPNFields()" required>
                                                <option value="">Seleccione</option>
                                                <option>Internet</option>
                                                <option>VPN</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- VPN campos -->
                                    <div class="mb-3" id="vpnFields" style="display: none;">
                                        <label>VPN (IP válida):</label>
                                        <input type="text" class="form-control mb-2" id="vpnCliente"
                                            placeholder="Ej: 10.0.0.1">
                                        <label>Service (TCP, UDP y puerto) o Protocolo:</label>
                                        <input type="text" class="form-control" id="proxyBanco"
                                            placeholder="Ej: TCP 443">
                                    </div>

                                    <!-- IP y puerto -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label>IP Cliente:</label>
                                            <input type="text" class="form-control" id="ipCliente"
                                                placeholder="Ej: 192.168.0.1" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label>Puerto:</label>
                                            <input type="number" class="form-control" id="puertoCliente" required>
                                        </div>
                                    </div>

                                    <!-- Convenios -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label>Convenios:</label>
                                            <input type="text" class="form-control" id="convenios"
                                                placeholder="Ej: 3456, 6578" required>
                                        </div>
                                        <div class="col-md-6">
                                        </div>
                                    </div>

                                    <!-- Tabla editable -->
                                    <div class="mb-3">
                                        <div
                                            class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-2">
                                            <span class="fw-bold">Tabla de Facturas:</span>
                                            <div class="d-flex flex-wrap gap-2">
                                                <!-- Botón: Cargar set de datos -->
                                                <button type="button" id="btnCargaDatos"
                                                    class="btn btn-secondary btn-sm d-flex align-items-center gap-1"
                                                    onclick="abrirModalCarga()">
                                                    <i class="bi bi-upload"></i> Cargar set de datos
                                                </button>

                                                <!-- Botón: Añadir fila -->
                                                <button type="button" id="btnAgregarFila"
                                                    class="btn btn-success btn-sm d-flex align-items-center gap-1"
                                                    onclick="agregarFila()">
                                                    <i class="bi bi-plus-circle"></i> Añadir fila
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Tabla responsive -->
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-sm align-middle text-nowrap"
                                                id="tablaFacturacion">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th style="width: 15%;" class="text-center align-middle">Factura
                                                        </th>
                                                        <th style="width: 15%;" class="text-center align-middle">NIT
                                                        </th>
                                                        <th style="width: 15%;" class="text-center align-middle">Número
                                                            de Negocio</th>
                                                        <th style="width: 30%;" class="text-center align-middle">Factura
                                                            Código de Barras<br><small>(Espectro completo)</small></th>
                                                        <th style="width: 15%;" class="text-center align-middle">Valor
                                                        </th>
                                                        <th style="width: 5%;" class="text-center align-middle"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Filas dinámicas se agregan aquí -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Botón de envío -->
                                    <div class="text-end mt-3">
                                        <button type="submit" id="validarFormulario"
                                            class="btn btn-primary">Validar</button>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div id="liveAlertPlaceholder"></div>
        <!-- Card para cargar archivos XML -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="card-title">Cargar Archivos SOAP</h4>
                    <!-- Contenedor para el botón de tour -->
                    <div class="d-flex align-items-center">
                    </div>
                </div>
                <!-- Input para cargar archivo XML base -->
                <div id="inputFiles">
                    <div class="mb-3">
                        <label for="fileInput1" class="form-label">Seleccionar SOAP Banco</label>
                        <input type="file" class="form-control" id="fileInput1" accept=".xml">
                    </div>
                    <!-- Input para cargar archivo XML a comparar -->
                    <div class="mb-3">
                        <label for="fileInput2" class="form-label">Seleccionar SOAP Cliente</label>
                        <input type="file" class="form-control" id="fileInput2" accept=".xml">
                    </div>
                </div>
                <!-- Select para seleccionar archivo XML desde una lista -->
                <div class="mb-3">
                    <label for="xmlFileSelect" class="form-label">Seleccionar SOAP Banco desde lista</label>
                    <select class="form-select" id="xmlFileSelect">
                        <option value="">Seleccionar archivo</option>
                    </select>
                </div>
                <!-- 
                    Radios: tipo mapeo.  
                    Lista Método: ops por WS.  
                    Lista Método se activa según Lista Tipo Web Service.  
                    Al elegir, se muestra selección.
                -->
                <div id="radioButtons" class="row g-3 align-items-center">

                    <!-- Radios -->
                    <div class="col-12 col-md-6">
                        <label class="form-label d-block mb-1">Tipo Mapeo:</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoMapeo" id="flexRadioRequest"
                                value="Request" checked>
                            <label class="form-check-label" for="flexRadioRequest">Mapeo Request</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoMapeo" id="flexRadioResponse"
                                value="Response">
                            <label class="form-check-label" for="flexRadioResponse">Mapeo Response</label>
                        </div>
                    </div>

                    <!-- Lista desplegable -->
                    <div class="col-12 col-md-6">
                        <label for="metodoWebService" class="form-label">Método:</label>
                        <select id="metodoWebService" class="form-select" disabled>
                            <option value="">Primero selecciona tipo WS</option>
                        </select>
                    </div>

                </div>

                <!-- Accordion para secciones de eliminar y subir archivos XML -->
                <div class="accordion accordion-flush mt-4" id="accordionFlushExample">
                    <!-- Template para eliminar archivos XML -->
                    <template id="templateEliminarArchivosXML">

                        <!-- Sección de eliminar archivos XML -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="flush-headingOne">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#flush-collapseOne" aria-expanded="false"
                                    aria-controls="flush-collapseOne">
                                    <!-- El texto del botón será modificado dinámicamente por el script -->
                                </button>
                            </h2>
                            <div id="flush-collapseOne" class="accordion-collapse collapse"
                                aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlushExample">
                                <div class="accordion-body">
                                    <form id="deleteForm" class="d-flex">
                                        <select class="form-select me-2" id="deleteFileSelect" required></select>
                                        <button type="submit" class="btn btn-danger">Eliminar</button>
                                    </form>
                                </div>
                            </div>

                        </div>
                    </template>

                    <!-- Contenedor donde se insertará el template de eliminar archivos XML -->
                    <div id="containerEliminarArchivosXML"></div>

                    <!-- Template para subir archivos XML -->
                    <template id="templateSubirArchivosXML">
                        <!-- Sección de subir archivos XML -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="flush-headingTwo">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#flush-collapseTwo" aria-expanded="false"
                                    aria-controls="flush-collapseTwo">
                                    <!-- El texto del botón será modificado dinámicamente por el script -->
                                </button>
                            </h2>
                            <div id="flush-collapseTwo" class="accordion-collapse collapse"
                                aria-labelledby="flush-headingTwo" data-bs-parent="#accordionFlushExample">
                                <div class="accordion-body">
                                    <form id="uploadForm" enctype="multipart/form-data" class="d-flex">
                                        <input type="file" class="form-control me-2" id="fileInput" name="file"
                                            accept=".xml" required>
                                        <button type="submit" class="btn btn-primary">Subir</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Contenedor donde se insertará el template de subir archivos XML -->
                    <div id="containerSubirArchivosXML"></div>
                </div>
                <!-- Fin del Accordion -->
            </div>
        </div>

        <!-- Card para ingresar XML manualmente -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="card-title mb-0">Ingresar XML Manual</h4>
                    <div id="switchScroll" class="d-flex align-items-center">
                        <!-- Switch para activar/desactivar el scroll vertical -->
                        <div class="form-check form-switch me-3">
                            <input class="form-check-input" type="checkbox" id="scrollSwitch"
                                title="Activar Scroll Vertical">
                            <label class="form-check-label d-none d-md-flex" for="scrollSwitch">Activar Scroll
                                Vertical</label>
                        </div>
                        <!-- Campo de texto para el tamaño del scroll -->
                        <div>
                            <input type="number" class="form-control" id="scrollSizeInput" name="scrollSizeInput"
                                list="presetScrollSizes" min="1" pattern="\d*" disabled
                                title="Ingrese el tamaño del scroll en píxeles" autocomplete="current-scrollSizeInput">
                            <datalist id="presetScrollSizes">
                                <option value="100">
                                <option value="200">
                                <option value="300">
                                <option value="400">
                                <option value="500">
                                <option value="1000">
                            </datalist>
                        </div>
                    </div>
                </div>
                <!-- Textareas para comparar estructuras XML -->
                <div id="textAreasComparar" class="row">
                    <!-- Textarea para XML base -->
                    <div class="col-md-6 mb-3">
                        <text-area-xml id="textarea1" title="XML Banco" titleformat="Aplicar Formato"
                            titleclear="Limpiar" buttonformatid="formatXmlInput1" buttonclearid="clearXmlInput1"
                            textareaid="xmlInput1">
                        </text-area-xml>
                    </div>
                    <!-- Textarea para XML a comparar -->
                    <div class="col-md-6 mb-3">
                        <text-area-xml id="textarea2" title="XML Cliente" titleformat="Aplicar Formato"
                            titleclear="Limpiar" buttonformatid="formatXmlInput2" buttonclearid="clearXmlInput2"
                            textareaid="xmlInput2" placeholder="Ingresa código aquí...">
                        </text-area-xml>
                    </div>
                </div>

                <!-- Botón para comparar XML -->
                <div class="text-center">
                    <button id="cargarMapeos" class="btn btn-success">Cargar</button>
                    <button id="guardarDatos" class="btn btn-primary">Guardar</button>
                </div>
            </div>
        </div>
        <!-- Template para mostrar tabla Dummy Request -->
        <template id="templateDummyRequest">
            <div class="accordion" id="accordionDummyRequest">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingDummyRequest">
                        <button class="accordion-button bg-verde" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseDummyRequest" aria-expanded="true"
                            aria-controls="collapseDummyRequest">
                            VerificarEstadoWebService - Request
                        </button>
                    </h2>
                    <div id="collapseDummyRequest" class="accordion-collapse collapse show"
                        aria-labelledby="headingDummyRequest">
                        <div class="accordion-body">
                            <!-- Botón para exportar a Excel -->
                            <button id="exportToExcel" style="margin-top: 10px; display: none;">Exportar a
                                Excel</button>

                            <!-- Tabla de resultados -->
                            <table id="xmlTable" class="display" style="width:100%; display: none;">
                                <thead>
                                    <tr id="tableHeaders">
                                        <!-- Los encabezados se generarán dinámicamente -->
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    <!-- Aquí se llenarán las filas dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        <!-- Contenedor donde se insertará el template la tabla Dummy Request -->
        <div id="containerDummyRequest"></div>

        <!-- Template para mostrar tabla ConsultaFacturaPorNumero Request -->
        <template id="templateConsultaFacturaPorNumeroRequest">
            <div class="accordion" id="accordionFacturaNumeroRequest">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFacturaNumeroRequest">
                        <button class="accordion-button bg-verde" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseFacturaNumeroRequest" aria-expanded="true"
                            aria-controls="collapseFacturaNumeroRequest">
                            ConsultaFacturaPorNumero - Request
                        </button>
                    </h2>
                    <div id="collapseFacturaNumeroRequest" class="accordion-collapse collapse show"
                        aria-labelledby="headingFacturaNumeroRequest">
                        <div class="accordion-body">
                            <table id="xmlTable2" class="display" style="width:100%; display: none;">
                                <thead>
                                    <tr id="tableHeaders">
                                        <!-- Los encabezados se generarán dinámicamente -->
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    <!-- Aquí se llenarán las filas dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        <!-- Contenedor donde se insertará el template la tabla ConsultaFacturaPorNumero Request -->
        <div id="containerConsultaFacturaPorNumeroRequest"></div>

        <!-- Template para mostrar tabla RegistrarPagoIFX Request -->
        <template id="templateRegistrarPagoIFXRequest">
            <div class="accordion" id="accordionPagoIFXRequest">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingPagoIFXRequest">
                        <button class="accordion-button bg-verde" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapsePagoIFXRequest" aria-expanded="true"
                            aria-controls="collapsePagoIFXRequest">
                            RegistrarPagoIFX - Request
                        </button>
                    </h2>
                    <div id="collapsePagoIFXRequest" class="accordion-collapse collapse show"
                        aria-labelledby="headingPagoIFXRequest">
                        <div class="accordion-body">
                            <table id="xmlTable3" class="display" style="width:100%; display: none;">
                                <thead>
                                    <tr id="tableHeaders">
                                        <!-- Los encabezados se generarán dinámicamente -->
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    <!-- Aquí se llenarán las filas dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        <!-- Contenedor donde se insertará el template la tabla RegistrarPagoIFX Request -->
        <div id="containerRegistrarPagoIFXRequest"></div>

        <!-- Template para mostrar tabla Dummy Response -->
        <template id="templateDummyResponse">
            <div class="accordion" id="accordionDummyResponse">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingDummyResponse">
                        <button class="accordion-button bg-celeste" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseDummyResponse" aria-expanded="true"
                            aria-controls="collapseDummyResponse">
                            VerificarEstadoWebService - Response
                        </button>
                    </h2>
                    <div id="collapseDummyResponse" class="accordion-collapse collapse show"
                        aria-labelledby="headingDummyResponse">
                        <div class="accordion-body">
                            <!-- Botón para exportar a Excel -->
                            <button id="exportToExcel" style="margin-top: 10px; display: none;">Exportar a
                                Excel</button>

                            <!-- Tabla de resultados -->
                            <table id="xmlTable6" class="display" style="width:100%; display: none;">
                                <thead>
                                    <tr id="tableHeaders">
                                        <!-- Los encabezados se generarán dinámicamente -->
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    <!-- Aquí se llenarán las filas dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        <!-- Contenedor donde se insertará el template la tabla Dummy Response -->
        <div id="containerDummyResponse"></div>

        <!-- Template para mostrar tabla ConsultaFacturaPorNumero Response -->
        <template id="templateConsultaFacturaPorNumeroResponse">
            <div class="accordion" id="accordionFacturaNumeroResponse">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFacturaNumeroResponse">
                        <button class="accordion-button bg-celeste" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseFacturaNumeroResponse" aria-expanded="true"
                            aria-controls="collapseFacturaNumeroResponse">
                            ConsultaFacturaPorNumero - Response
                        </button>
                    </h2>
                    <div id="collapseFacturaNumeroResponse" class="accordion-collapse collapse show"
                        aria-labelledby="headingFacturaNumeroResponse">
                        <div class="accordion-body">
                            <table id="xmlTable7" class="display" style="width:100%; display: none;">
                                <thead>
                                    <tr id="tableHeaders">
                                        <!-- Los encabezados se generarán dinámicamente -->
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    <!-- Aquí se llenarán las filas dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        <!-- Contenedor donde se insertará el template la tabla ConsultaFacturaPorNumero Response -->
        <div id="containerConsultaFacturaPorNumeroResponse"></div>

        <!-- Template para mostrar tabla RegistrarPagoIFX Response -->
        <template id="templateRegistrarPagoIFXResponse">
            <div class="accordion" id="accordionPagoIFXResponse">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingPagoIFXResponse">
                        <button class="accordion-button bg-celeste" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapsePagoIFXResponse" aria-expanded="true"
                            aria-controls="collapsePagoIFXResponse">
                            RegistrarPagoIFX - Response
                        </button>
                    </h2>
                    <div id="collapsePagoIFXResponse" class="accordion-collapse collapse show"
                        aria-labelledby="headingPagoIFXResponse">
                        <div class="accordion-body">
                            <table id="xmlTable8" class="display" style="width:100%; display: none;">
                                <thead>
                                    <tr id="tableHeaders">
                                        <!-- Los encabezados se generarán dinámicamente -->
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    <!-- Aquí se llenarán las filas dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        <!-- Contenedor donde se insertará el template la tabla RegistrarPagoIFX Response -->
        <div id="containerRegistrarPagoIFXResponse">
            <br>
        </div>

        <!-- Card para mostrar el resultado del parceo -->
        <div id="cardResultComparer" class="card">
            <div class="card-body">
                <h4 class="card-title">Resultado del parseo XML</h4>
                <!-- Resultado de la comparación -->
                <pre id="comparisonResult" class="diff p-3 bg-light rounded"></pre>
                <div id="messageContainer" class="diff p-3 bg-light rounded"></div>
            </div>
        </div>

        <!-- Modal para cargar datos -->
        <div class="modal fade" id="modalCargaDatos" tabindex="-1" aria-labelledby="modalCargaDatosLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="formCargaDatos">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalCargaDatosLabel">Cargar Facturas</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <label for="textareaDatos" class="form-label">Pega los datos (separados por
                                coma):</label>
                            <textarea id="textareaDatos" class="form-control" rows="10"
                                placeholder="ej. Factura,NIT,Núm Negocio,Código Barras,Valor " required
                                title="Datos separados por coma"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary" id="btnCargarDatos"
                                onclick="this.blur()">Cargar</button>
                            <button type="button" class="btn btn-secondary" id="btnCancelarCargarDatos"
                                data-bs-dismiss="modal" onclick="this.blur()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para formatear datos -->
        <div class="modal fade" id="modalFormatoDatos" tabindex="-1" aria-labelledby="modalFormatoDatosLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="formFormatoDatos">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalFormatoDatosLabel">Formatear Datos</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Contenido Nodo -->
                            <div class="mb-3">
                                <label for="contenidoNodo" class="form-label">Contenido Nodo</label>
                                <input type="text" class="form-control" id="contenidoNodo" disabled>
                            </div>

                            <!-- Formato (select) -->
                            <div class="mb-3">
                                <label for="formato" class="form-label">Formato</label>
                                <select class="form-select" id="formato">
                                    <option value="" disabled selected>Selecciona una opción</option>
                                    <option value="quitar-guiones-cerosIzquierda">Quitar guiones y ceros a la izquierda
                                    </option>
                                    <option value="quitar-decimales">Quitar decimales</option>
                                    <option value="agregar-decimal">Agregar decimales</option>
                                    <option value="formato-fecha">Formato fecha</option>
                                    <option value="extraer">Extraer</option>
                                </select>
                            </div>

                            <!-- Formato Fecha (select adicional) oculto inicialmente -->
                            <div class="mb-3 d-none" id="grupoFormatoFecha">
                                <label for="formatoFecha" class="form-label">Formato fecha</label>
                                <select class="form-select" id="formatoFecha">
                                    <option value="" disabled selected>Selecciona un formato de fecha</option>
                                    <option value="YYYYMMDD">YYYYMMDD (20250506)</option>
                                    <option value="YYYY-MM-DD">YYYY-MM-DD (2025-05-06)</option>
                                    <option value="DDMMYYYY">DDMMYYYY (06052025)</option>
                                    <option value="YYYY/MM/DD">YYYY/MM/DD (2025/05/06)</option>
                                    <option value="DD/MM/YYYY">DD/MM/YYYY (06/05/2025)</option>
                                    <option value="MM-DD-YYYY">MM-DD-YYYY (05-06-2025)</option>
                                    <option value="DD de MM de YYYY">DD de MM de YYYY (06 de 05 de 2025)</option>
                                </select>
                            </div>

                            <!-- Extraer (dos inputs en una fila con "y" entre ellos, oculto inicialmente) -->
                            <div class="mb-3 d-none" id="grupoExtraer">
                                <div class="row align-items-end">
                                    <div class="col">
                                        <label for="extraerInicio" class="form-label">Entre</label>
                                        <input type="text" class="form-control" id="extraerInicio">
                                    </div>
                                    <div class="col-auto text-center">
                                        <span class="form-label d-block mb-2">y</span>
                                    </div>
                                    <div class="col">
                                        <label for="extraerFin" class="form-label">Entre</label>
                                        <input type="text" class="form-control" id="extraerFin">
                                    </div>
                                </div>
                            </div>

                            <!-- Resultado esperado -->
                            <div class="mb-3">
                                <label for="resultadoEsperado" class="form-label">Resultado esperado</label>
                                <input type="text" class="form-control" id="resultadoEsperado" disabled>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary" id="btnAplicarFormato" data-bs-dismiss="modal"
                                onclick="this.blur()">Aplicar</button>
                            <button type="button" class="btn btn-secondary" id="btnCancelarFormato"
                                data-bs-dismiss="modal" onclick="this.blur()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


        <!-- Modal Solución -->
        <modal-xml title="Actualizar Solución" titleLabel1="ID de la solición" inputid1="idSolucion"
            titletextarea1="Descripción de la causa" idtextarea1="descripcionCausaSolucion"
            titletextarea2="Descripción de la solución" idtextarea2="descripcionSolucion" modalid="modalSolucion"
            numtextareas="2" numimputs="1" namefunction="actualizarSolucion()"></modal-xml>

    </div>

    <!-- Navegación fija en la parte inferior -->
    <nav class="navbar fixed-bottom navbar-expand-sm navbar-dark bg-dark">
        <!-- Botón de alternancia para la barra de navegación en pantallas pequeñas -->
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse"
            aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <!-- Icono del botón de alternancia -->
            <span class="navbar-toggler-icon"></span>
        </button>
        <!-- Contenedor colapsable para los elementos de la barra de navegación -->
        <div class="collapse navbar-collapse dropup" id="navbarCollapse">
            <!-- Lista de navegación principal -->
            <ul class="navbar-nav mr-auto">
                <!-- Elemento de navegación con un menú desplegable -->
                <li class="nav-item dropup">
                    <!-- Enlace del menú desplegable -->
                    <a class="nav-link dropdown-toggle" href="#" id="dropdown10" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false">Herramientas XML</a>
                    <!-- Contenido del menú desplegable -->
                    <div class="dropdown-menu" aria-labelledby="dropdown10">
                        <!-- Opción del menú que enlaza a 'Comparar Estructuras XML' -->
                        <a class="dropdown-item" href="index.html">Comparar Estructuras XML</a>
                        <!-- Opción del menú que enlaza a 'Validar XML' -->
                        <a class="dropdown-item" href="validarXML.html">Validar XML</a>
                        <!-- Opción del menú que enlaza a 'Lector Inventario Certificados' -->
                        <a class="dropdown-item" href="inventarioCert.html">Inventario Certificados</a>
                        <!-- Opción del menú que enlaza a 'Log de errores' -->
                        <a class="dropdown-item" href="logErrores.html">Log de errores</a>
                        <!-- Opción del menú que enlaza a 'Mapeos de mensajes' -->
                        <a class="dropdown-item" href="mapeosMensajes.html">Mapeos de mensajes</a>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <script id="baseScript">
        function abrirModalCarga() {
            const modal = new bootstrap.Modal(document.getElementById('modalCargaDatos'));
            modal.show();
        }

        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('formCargaDatos');
            const tabla = document.querySelector('#tablaFacturacion tbody');
            const textarea = document.getElementById('textareaDatos');

            form.addEventListener('submit', function (e) {
                e.preventDefault();

                const lineas = textarea.value.trim().split('\n');

                lineas.forEach(linea => {
                    const columnas = linea.split(',').map(col => col.trim());

                    if (columnas.length >= 5) {
                        const factura = columnas[0];
                        const nit = columnas[1];
                        const negocio = columnas[2];
                        const codBarras = columnas[3];
                        const valor = columnas[4];

                        const fila = document.createElement('tr');
                        fila.innerHTML = `
                            <td class="text-center align-middle">${factura}</td>
                            <td class="text-center align-middle">${nit}</td>
                            <td class="text-center align-middle">${negocio}</td>
                            <td class="text-center align-middle">${codBarras}</td>
                            <td class="text-center align-middle">${valor}</td>
                            <td>
                            <button class="btn btn-danger btn-sm" onclick="eliminarFila(this)">✕</button>
                            </td>
                        `;
                        tabla.appendChild(fila);
                    }
                });

                textarea.value = '';
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalCargaDatos'));
                modal.hide();
            });
        });

        function eliminarFila(boton) {
            boton.closest('tr').remove();
        }

        function agregarFila() {
            const tabla = document.getElementById("tablaFacturacion").getElementsByTagName('tbody')[0];
            const nuevaFila = tabla.insertRow();

            // Crear celdas con inputs
            for (let i = 0; i < 5; i++) {
                const celda = nuevaFila.insertCell(i);
                const input = document.createElement("input");
                // input.type = i === 4 ? "number" : "text";
                input.type = "text";
                input.className = "form-control";
                celda.appendChild(input);
            }

            // Agregar botón para eliminar fila
            const celdaAcciones = nuevaFila.insertCell(5);
            const botonEliminar = document.createElement("button");
            botonEliminar.className = "btn btn-danger btn-sm";
            botonEliminar.textContent = "✕";
            botonEliminar.onclick = function () {
                tabla.deleteRow(nuevaFila.rowIndex - 1);
            };
            celdaAcciones.appendChild(botonEliminar);
        }

        function toggleAuthSelect() {
            const authCheck = document.getElementById('authBasicCheck');
            const authSelect = document.getElementById('authBasic');
            authSelect.style.display = authCheck.checked ? 'block' : 'none';
        }


        function toggleVPNFields() {
            const tipo = document.getElementById('tipoConectividad').value;
            const vpnFields = document.getElementById('vpnFields');
            vpnFields.style.display = tipo === 'VPN' ? 'block' : 'none';
        }

        function obtenerValorElementoHTML(celda) {
            const select = celda.querySelector('select');
            const input = celda.querySelector('input');
            const span = celda.querySelector('span');
            const textarea = celda.querySelector('textarea');

            if (select) return select.options[select.selectedIndex]?.text?.trim() || '';
            if (input) return input.value?.trim() || '';
            if (span) return span.textContent?.trim() || '';
            if (textarea) return textarea.value?.trim() || '';
            return celda.textContent?.trim() || '';
        }

        function formatearDatosDesdeTablaActiva(tableId) {
            const tableElement = document.getElementById(tableId);
            if (!tableElement || !tableElement.querySelector('tbody tr')) return [];

            const headers = Array.from(tableElement.querySelectorAll('thead th'))
                .map(th => th.textContent.trim());

            const filasFormateadas = [];

            $(`#${tableId} tbody tr`).each(function () {
                const fila = {};
                $(this).find('td').each(function (index) {
                    const key = headers[index] || `Columna ${index + 1}`;
                    const valor = obtenerValorElementoHTML(this);
                    fila[key] = valor;
                });
                filasFormateadas.push(fila);
            });

            return filasFormateadas;
        }

        $('#guardarDatos').click(function () {
            const formOriginal = document.getElementById('formRequerimiento');
            const formClonado = formOriginal.cloneNode(true).outerHTML;
            const tipoWS = document.getElementById('listaTipoWebService').value;
            const tablaIds = ['xmlTable', 'xmlTable2', 'xmlTable3', 'xmlTable6', 'xmlTable7', 'xmlTable8'];

            const resultado = {};

            tablaIds.forEach(id => {
                const filas = formatearDatosDesdeTablaActiva(id);
                if (filas.length > 0) {
                    resultado[id] = filas;
                }
            });

            let htmlOutput = `
                <div class="accordion" id="accordionTablas">
            `;

            let indexAccordion = 0;

            for (const [tablaId, registros] of Object.entries(resultado)) {
                let titulo = '';
                // Asignar título según el ID de la tabla
                switch (tablaId) {
                    case 'xmlTable':
                        titulo = 'VerificarEstadoWebService - Request';
                        break;
                    case 'xmlTable2':
                        titulo = 'ConsultaFacturaPorNumero - Request';
                        break;
                    case 'xmlTable3':
                        titulo = 'RegistrarPagoIFX - Request';
                        break;
                    case 'xmlTable6':
                        titulo = 'VerificarEstadoWebService - Response';
                        break;
                    case 'xmlTable7':
                        titulo = 'ConsultaFacturaPorNumero - Response';
                        break;
                    case 'xmlTable8':
                        titulo = 'RegistrarPagoIFX - Response';
                        break;
                    default:
                        titulo = tablaId;
                }

                const collapseId = `collapse${indexAccordion}`;
                const headingId = `heading${indexAccordion}`;

                htmlOutput += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="${headingId}">
                            <button class="accordion-button ${indexAccordion > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="${indexAccordion === 0}" aria-controls="${collapseId}">
                                ${titulo}
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse ${indexAccordion === 0 ? 'show' : ''}" aria-labelledby="${headingId}" data-bs-parent="#accordionTablas">
                            <div class="accordion-body">
                `;

                registros.forEach((registro, regIndex) => {
                    const contenido = Object.entries(registro)
                        .map(([clave, valor]) => `<strong>${clave}:</strong> ${valor}`)
                        .join('<br>');

                    htmlOutput += `
                        <div class="card mb-3 registro" style="background-color: white;">
                            <div class="card-body">
                                <p class="card-text">${contenido}</p>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input color-radio" type="radio" name="color${tablaId}${regIndex}" value="lightgreen">
                                    <label class="form-check-label">✔ Todo Ok (completo)</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input color-radio" type="radio" name="color${tablaId}${regIndex}" value="orange">
                                    <label class="form-check-label">⚠ Requiere Pruebas</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input color-radio" type="radio" name="color${tablaId}${regIndex}" value="#e74c3c">
                                    <label class="form-check-label">✖ Consultar con Analista</label>
                                </div>
                            </div>
                        </div>
                    `;
                });

                htmlOutput += `
                            </div>
                        </div>
                    </div>
                `;

                indexAccordion++;
            }

            htmlOutput += `</div>`; // cierre de accordion

            // Abrimos una nueva ventana y escribimos el HTML
            const outputWindow = window.open('', 'HTML Output', 'width=1000,height=800');

            outputWindow.document.write(`
                        <!DOCTYPE html>
                        <html lang="es">
                            <head>
                                <meta charset="UTF-8" />
                                <title>Resultado HTML</title>
                                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous"/>
                                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.css"/>
                            </head>
                            <body class="bg-light p-4">
                                <div class="container">
                                    <h3 class="mb-4 text-center">Mapeos ${tipoWS}</h3>
                                    ${formClonado}
                                    <br />
                                    ${htmlOutput}
                                    <br />
                                    <h3 class="mb-4 text-center">Pruebas Antes de Desarrollo</h3>
                                    <div id="editor-container"></div>
                                    <!-- Contenedor de botones alineados -->
                                    <div class="d-flex justify-content-between mt-4">
                                        <button class="btn btn-secondary" id="add-editors-btn">Añadir Editores</button>
                                        <button id="guardarButton" class="btn btn-primary">Guardar HTML</button>
                                    </div>
                                </div>
                            </body>
                        </html>
                    `);


            // // Esperar a que la ventana cargue y luego insertar los datos
            // outputWindow.document.addEventListener('DOMContentLoaded', function () {
            //     const datosFormularioDiv = outputWindow.document.getElementById('datosFormulario');
            //     datosFormularioDiv.innerHTML = formularioHTML;
            // });

            // Obtener el formulario clonado en la nueva ventana
            const formClonadoEnVentana = outputWindow.document.querySelector('#formRequerimiento');

            if (formClonadoEnVentana) {
                copiarValoresPorId(formOriginal, formClonadoEnVentana);
                deshabilitarCampos(formClonadoEnVentana);
            }

            const btnCargaDatos = outputWindow.document.querySelector('#btnCargaDatos');
            if (btnCargaDatos) btnCargaDatos.remove();

            const btnAgregarFila = outputWindow.document.querySelector('#btnAgregarFila');
            if (btnAgregarFila) btnAgregarFila.remove();

            const validarFormulario = outputWindow.document.querySelector('#validarFormulario');
            if (validarFormulario) validarFormulario.remove();

            const tabla = formClonadoEnVentana.querySelector('#tablaFacturacion');
            if (tabla) {
                tabla.querySelectorAll('tr').forEach(fila => {
                    // Reemplazar inputs por su valor
                    fila.querySelectorAll('td').forEach((celda, index) => {
                        celda.classList.add('text-center', 'align-middle');
                        const input = celda.querySelector('input');
                        if (input) {
                            celda.textContent = input.value; // Reemplaza el contenido del <td> con el valor del input
                        }
                    });

                    // Elimina la última celda de cada fila (la columna de acciones)
                    fila.deleteCell(-1);
                });
            }

            // Bootstrap JS
            const bootstrapScript = outputWindow.document.createElement('script');
            bootstrapScript.src = "https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js";
            bootstrapScript.integrity = "sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq";
            bootstrapScript.crossOrigin = "anonymous";
            outputWindow.document.head.appendChild(bootstrapScript);

            const style = outputWindow.document.createElement('style');
            style.textContent = `
                    .CodeMirror {
                        height: auto;
                        border: 1px solid #ced4da;
                        margin-bottom: 1rem;
                    }
                    .editor-group {
                        padding: 1rem;
                        border-radius: 0.5rem;
                        background-color: #f8f9fa;
                    }
                `;
            outputWindow.document.head.appendChild(style);


            // Script para guardar HTML

            const scriptGuardar = outputWindow.document.createElement('script');
            scriptGuardar.textContent = `
document.getElementById('guardarButton').addEventListener('click', function () {
    // Marcar los radios seleccionados con 'checked'
    document.querySelectorAll('input[type="radio"]').forEach(r =>
        r.checked ? r.setAttribute('checked', 'checked') : r.removeAttribute('checked')
    );

    // Clonar documento completo
    const clonedDoc = document.documentElement.cloneNode(true);
    const formOriginal = document.getElementById('formRequerimiento');
    const formClonado = clonedDoc.querySelector('#formRequerimiento');

    // Recolectar datos del formulario original como clave: valor
    const datosFormulario = {};
    formOriginal.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.type === 'radio' || el.type === 'checkbox') {
            datosFormulario[el.id] = el.checked;
        } else {
            datosFormulario[el.id] = el.value;
        }
    });

    // Eliminar elementos no deseados del documento clonado
    ['header1-row-', 'header2-row-'].forEach(prefix =>
        clonedDoc.querySelectorAll("div[id^=" + prefix + "]").forEach(div => div.remove())
    );

    const addBtn = clonedDoc.querySelector('#add-editors-btn');
    if (addBtn) addBtn.remove();

    // Verificar si el script de eliminar editores
    const existingEditoresScript = clonedDoc.querySelector('#editoresScript');
    if (existingEditoresScript) existingEditoresScript.remove();

    // Verificar si el script de restauración ya ha sido agregado
    const existingRestoreScript = clonedDoc.querySelector('#restoreScript');
    if (!existingRestoreScript) {
        // Inyectar el script que restaurará los valores solo si no existe ya
        const restoreScript = document.createElement('script');
        restoreScript.id = 'restoreScript';
        restoreScript.textContent = \`
            document.addEventListener('DOMContentLoaded', function () {
                const datosFormulario = \${JSON.stringify(datosFormulario)};
                Object.entries(datosFormulario).forEach(([id, valor]) => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (el.type === 'checkbox' || el.type === 'radio') {
                            el.checked = valor;
                        } else {
                            el.value = valor;
                        }
                    }
                });
            });
        \`;
        clonedDoc.querySelector('body').appendChild(restoreScript);
    }

    // Generar contenido final y descargar
    const doctype = '<!DOCTYPE html>\\n';
    const htmlContent = doctype + clonedDoc.outerHTML;
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'mapeos_mensajes.html';
    link.click();
});
`;


            // Agregar el script de guardado al DOM
            outputWindow.document.body.appendChild(scriptGuardar);


            // Script para cambiar fondo por check
            const scriptColor = outputWindow.document.createElement('script');
            scriptColor.textContent = `
                function cambiarColor(div) {
                    const selectedRadio = div.querySelector('input[type="radio"]:checked');
                    if (selectedRadio) {
                        div.style.backgroundColor = selectedRadio.value;
                    } else {
                        div.style.backgroundColor = 'white';
                    }
                }

                document.querySelectorAll('.registro').forEach(function(div) {
                    div.querySelectorAll('input[type="radio"]').forEach(function(input) {
                        input.addEventListener('change', function() {
                            cambiarColor(div);
                        });
                    });

                    // Aplicar color si ya viene uno seleccionado
                    cambiarColor(div);
                });
            `;

            outputWindow.document.body.appendChild(scriptColor);

            // CodeMirror JS core
            const codeMirrorCore = outputWindow.document.createElement('script');
            codeMirrorCore.src = "https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js";
            outputWindow.document.body.appendChild(codeMirrorCore);

            // CodeMirror XML mode
            const codeMirrorMode = outputWindow.document.createElement('script');
            codeMirrorMode.src = "https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/xml/xml.min.js";
            outputWindow.document.body.appendChild(codeMirrorMode);

            // Script para editores de pruebas antes de desarrollo
            const scriptPruebas = outputWindow.document.createElement('script');
            scriptPruebas.id = 'editoresScript';
            scriptPruebas.textContent = `
                let editorCount = 0;

                function removeEditorGroup(id) {
                    const group = document.getElementById(\`group-\${id}\`);
                    if (group) group.remove();
                }

                document.getElementById('add-editors-btn').addEventListener('click', () => {
                    editorCount++;

                    const container = document.getElementById('editor-container');

                    const group = document.createElement('div');
                    group.className = 'editor-group';
                    group.id = \`group-\${editorCount}\`;

                    const accordionId1 = \`accordion\${editorCount}_1\`;
                    const accordionId2 = \`accordion\${editorCount}_2\`;

                    group.innerHTML = \`
                    <div class="mb-3">
                        <label for="title1-\${editorCount}" class="form-label">Request:</label>
                        <div id="header1-row-\${editorCount}" class="d-flex justify-content-between align-items-start mb-2">
                            <input type="text" class="form-control me-2" id="title1-\${editorCount}" placeholder="Título 1" value="Editor Request \${editorCount}">
                            <button class="btn-close" aria-label="Cerrar" onclick="removeEditorGroup(\${editorCount})"></button>
                        </div>
                        <div class="accordion" id="\${accordionId1}">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse1-\${editorCount}" aria-expanded="true">
                                <span id="header1-\${editorCount}">Editor Request \${editorCount}</span>
                            </button>
                            </h2>
                            <div id="collapse1-\${editorCount}" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <textarea id="editor1-\${editorCount}"></textarea>
                            </div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="title2-\${editorCount}" class="form-label">Response:</label>
                        <div id="header2-row-\${editorCount}">
                            <input type="text" class="form-control mb-2" id="title2-\${editorCount}" placeholder="Título 2" value="Editor Response \${editorCount}">
                        </div>
                        <div class="accordion" id="\${accordionId2}">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse2-\${editorCount}" aria-expanded="true">
                                <span id="header2-\${editorCount}">Editor Response \${editorCount}</span>
                            </button>
                            </h2>
                            <div id="collapse2-\${editorCount}" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <textarea id="editor2-\${editorCount}"></textarea>
                            </div>
                            </div>
                        </div>
                        </div>
                    </div>

                    \`;

                    container.appendChild(group);

                    // Iniciar CodeMirror en ambos editores
                    CodeMirror.fromTextArea(document.getElementById(\`editor1-\${editorCount}\`), {
                    mode: "xml",
                    lineNumbers: true
                    });
                    CodeMirror.fromTextArea(document.getElementById(\`editor2-\${editorCount}\`), {
                    mode: "xml",
                    lineNumbers: true
                    });

                    // Asociar inputs a títulos del acordeón
                    const titleInput1 = document.getElementById(\`title1-\${editorCount}\`);
                    const headerSpan1 = document.getElementById(\`header1-\${editorCount}\`);
                    titleInput1.addEventListener('input', () => {
                    headerSpan1.textContent = titleInput1.value;
                    });

                    const titleInput2 = document.getElementById(\`title2-\${editorCount}\`);
                    const headerSpan2 = document.getElementById(\`header2-\${editorCount}\`);
                    titleInput2.addEventListener('input', () => {
                    headerSpan2.textContent = titleInput2.value;
                    });
                });
                `;

            outputWindow.document.body.appendChild(scriptPruebas);

            outputWindow.document.close(); // Finalizar escritura del documento
        });

        function generarHTML(tipoWS, formHTML, contenido) {
            return `
                <html>
                <head>
                    <title>Resultado HTML</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
                </head>
                <body class="bg-light p-4">
                    <div class="container">
                        <h1 class="mb-4">Mapeos ${tipoWS}</h1>
                        ${formHTML}
                        <div class="accordion" id="accordionTablas">
                            ${contenido.join('')}
                        </div>
                        <button id="guardarButton" class="btn btn-primary mt-4">Guardar HTML</button>
                        <h2 class="mb-4">Pruebas Antes de Desarrollo</h2>
                        <div id="editor-container"></div>
                        <button class="btn btn-primary mt-3" id="add-editors-btn">Agregar par de editores</button>
                    </div>
                </body>
                </html>
            `;
        }

        function copiarValoresPorId(formOriginal, formClonado) {
            const elementosOriginales = formOriginal.querySelectorAll('[id]');

            elementosOriginales.forEach(elementoOriginal => {
                const idOriginal = elementoOriginal.id;
                const elementoClonado = formClonado.querySelector(`#${idOriginal}`);

                if (elementoClonado) {
                    // Copiar inputs dentro de la tabla, si existen
                    const inputsOriginales = elementoOriginal.querySelectorAll('input, select, textarea');
                    const inputsClonados = elementoClonado.querySelectorAll('input, select, textarea');

                    if (inputsOriginales.length && inputsOriginales.length === inputsClonados.length) {
                        inputsOriginales.forEach((inputOriginal, index) => {
                            const inputClonado = inputsClonados[index];
                            if (inputClonado) {
                                if (inputOriginal.type === 'checkbox' || inputOriginal.type === 'radio') {
                                    inputClonado.checked = inputOriginal.checked;
                                } else {
                                    inputClonado.value = inputOriginal.value;
                                }
                            }
                        });
                    } else {
                        // Si no hay inputs anidados, se trata como campo individual
                        if (elementoOriginal.type === 'checkbox') {
                            elementoClonado.checked = elementoOriginal.checked;
                        } else if (elementoOriginal.type === 'radio') {
                            const radiosOriginal = formOriginal.querySelectorAll(`input[type="radio"][name="${elementoOriginal.name}"]`);
                            const radiosClonados = formClonado.querySelectorAll(`input[type="radio"][name="${elementoOriginal.name}"]`);
                            radiosOriginal.forEach((radioOriginal, index) => {
                                if (radioOriginal.checked && radiosClonados[index]) {
                                    radiosClonados[index].checked = true;
                                }
                            });
                        } else if (['SELECT', 'INPUT', 'TEXTAREA'].includes(elementoOriginal.tagName)) {
                            elementoClonado.value = elementoOriginal.value;
                        } else if (['TD', 'SPAN'].includes(elementoOriginal.tagName)) {
                            elementoClonado.textContent = elementoOriginal.textContent;
                        }
                    }
                }
            });
        }

        function deshabilitarCampos(formClonado) {
            const elements = formClonado.querySelectorAll('input, select, button');
            elements.forEach(el => {
                if (el.type !== 'button' && el.type !== 'submit') {
                    el.disabled = true;
                }
            });
        }
    </script>

    <!-- Incluir la biblioteca jsdiff para comparar diferencias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.2.0/diff.min.js"></script>
    <!-- Incluir CodeMirror para la edición de XML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <!-- Incluir modo XML para CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <!-- Incluir js-beautify para formatear XML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.13.5/beautify.min.js"></script>
    <!-- Incluir el JavaScript de Shepherd.js para tour en la APP -->
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@8.3.1/dist/js/shepherd.min.js"></script>
    <!-- CodeMirror fullscreen JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/display/fullscreen.min.js"></script>
    <!-- CodeMirror-placeholder -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/addon/display/placeholder.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
        crossorigin="anonymous"></script>

</body>

</html>